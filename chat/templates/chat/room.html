{% extends "base_with_sidebar.html" %}

{% block content %}
<h2>
    Chat Room: {{ room.name }}
    <a href="{% url 'chat:chat_index' %}" class="btn btn-secondary ms-2">Back to Chats</a>
</h2>

<form method="post" class="mb-3">
  {% csrf_token %}
  {% if is_member %}
    <button type="submit" name="action" value="unsubscribe" class="btn btn-danger">Unsubscribe</button>
  {% else %}
    <button type="submit" name="action" value="subscribe" class="btn btn-success">Subscribe</button>
  {% endif %}
</form>

<div id="chat-log" class="border rounded p-3 mb-3" style="height: 300px; overflow-y: auto; background: #f8f9fa;">
  {% for msg in messages %}
    <div><strong>{{ msg.sender.profile.public_name }}:</strong> {{ msg.content }}</div>
  {% empty %}
    <div>No messages yet. Start the conversation!</div>
  {% endfor %}
</div>

<div class="input-group mb-3">
  <input id="chat-message-input" type="text" class="form-control" placeholder="Type here to chat" autocomplete="off" autofocus>
  <button id="chat-message-submit" class="btn btn-primary">Send</button>
</div>

<script>
  //const roomName = "{{ room.name|escapejs }}";
  const roomId = "{{ room.id }}"; 

  // Use secure WebSocket if protocol is https
  const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';

  const chatSocket = new WebSocket(
    wsProtocol + window.location.host + '/ws/chat/' + roomId + '/'
  );

  const chatLog = document.querySelector('#chat-log');
  const messageInput = document.querySelector('#chat-message-input');
  const sendButton = document.querySelector('#chat-message-submit');

  // Append message with display name to chat log
  function appendMessage(displayName, message) {
    const messageElement = document.createElement('div');
    messageElement.innerHTML = `<strong>${displayName}:</strong> ${message}`;
    chatLog.appendChild(messageElement);
    chatLog.scrollTop = chatLog.scrollHeight;  // Auto scroll to latest message
  }

  chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    appendMessage(data.display_name, data.message);
  };

  chatSocket.onclose = function(e) {
    console.error('Chat socket closed unexpectedly');
  };

  // Send message on click or Enter key
  sendButton.onclick = function() {
    const message = messageInput.value.trim();
    if (message) {
      chatSocket.send(JSON.stringify({ 'message': message }));
      messageInput.value = '';
      messageInput.focus();
    }
  };

  messageInput.addEventListener('keyup', function(event) {
    if (event.key === 'Enter') {
      sendButton.click();
    }
  });
</script>
{% endblock %}
